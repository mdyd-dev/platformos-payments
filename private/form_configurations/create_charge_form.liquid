---
name: create_charge_form
resource: modules/stripe_payments/charge
resource_owner: anyone
fields:
  properties:
    stripe_id:
    credit_card_id:
    amount_cents:
    application_fee_cents:
    currency:
    description:
    statement_descriptor:
    customer_id:
    destination:
    transfer_group:
    response:
    response_errors:
    status:
    paid_at:
    failed_at:
default_payload: >
  {% if form %}
    {% assign data = params.properties_attributes | to_hash %}
    {%- query_graph 'modules/stripe_payments/get_customer', result_name: 'g_customer', id: data.customer_id -%}
    {% assign customer_id = data.customer_id %}
    {% assign stripe_customer_id = g_customer.customizations.results.first.stripe_id %}
    {%- query_graph 'modules/stripe_payments/get_credit_cards_by_customer_id', result_name: 'g_cc', id: data.credit_card_id, customer_id: customer_id -%}
    {% assign source = g_cc.customizations.results.first.properties.stripe_id %}
    {% assign credit_card_id = g_cc.customizations.results.first.id %}

    {% parse_json request_data %}
      {
        "amount": "{{ data.amount_cents }}",
        "application_fee": "{{ data.application_fee_cents }}",
        "currency": "{{ data.currency }}",
        "description": "{{ data.description }}",
        "statement_descriptor": "{{ data.statement_descriptor }}",
        "customer": "{{ stripe_customer_id }}",
        "destination": "{{ data.destination }}",
        "source": "{{ source }}",
        "metadata": {{ data.metadata | default: 'null' }}
      }
    {% endparse_json %}
    {%- execute_query 'modules/stripe_payments/create_charge_in_stripe', result_name: 'g', data: request_data -%}

    {% assign now = 'now' | to_time | strftime: "%d-%m-%Y %H:%M:%S"  %}
    {% assign response_body = g.api_call_send.response.body | to_hash %}
    {
      "properties_attributes": {
        "credit_card_id": "{{ credit_card_id }}",
        "customer_id": "{{ customer_id }}",
        "status": "{{ response_body.status | default: 'failed' }}",
        {% if response_body.error != blank or response_body.status != 'succeeded' %}
          "response_errors": {{ g.api_call_send.response.body | json | strip_newlines }},
          "failed_at": "{{ now }}"
        {% else %}
          "stripe_id": "{{ response_body.id }}",
          "paid_at": "{{ now }}",
          "response": {{ g.api_call_send.response.body | json | strip_newlines }}
        {% endif %}
      }
    }
  {% endif %}
---
